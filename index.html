<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aeropath VSS & KML Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="static/ruler/leaflet-ruler.css" />
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="static/ruler/leaflet-ruler.js"></script>
</head>

<body>
  <div class="sidebar d-flex flex-column" style="height: 100vh;">
    <div class="flex-grow-1">
      <h5 class="mb-4 d-flex align-items-center justify-content-between">
        <span class="d-flex align-items-center">
          <img src="static/images/aeropath.png" alt="Aeropath Logo"
            style="height: 2rem; width: 2rem; margin-right: 0.5rem;">
          PD Data Manager KMLGen
        </span>
        <span class="badge badge-sm rounded-pill bg-primary ms-2" style="font-size:0.5=65em;">v0.0.3</span>
      </h5>
      <div class="card mb-4">
        <!-- <h5 class="card-header">General</h5> -->
        <div class="card-body">
          <div class="mb-4 d-flex align-items-center">
            <div class="flex-grow-1 me-2">
              <label for="aerodrome-search" class="form-label">Aerodrome</label>
              <div class="position-relative">
                <input type="text" class="form-control" id="aerodrome-search" autocomplete="off"
                  placeholder="Type to search...">
                <input type="hidden" id="aerodrome" name="aerodrome"> <!-- This will store the selected ICAO -->
                <div id="aerodrome-list-container" class="list-group position-absolute w-100"
                  style="z-index: 1050; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #ced4da; background-color: white;">
                  <!-- Aerodrome items will be populated here -->
                </div>
              </div>
            </div>
            <div class="align-self-end mb-1">
              <button id="refresh-aerodrome" type="button" class="btn btn-secondary btn-sm"
                title="Refresh Aerodrome List">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>
          <div class="mb-2">
            <label for="surface-type" class="form-label">Surface</label>
            <select class="form-select" id="surface-type">
              <option value="vss">VSS</option>
              <option value="dep_ois">DEP OIS</option>
            </select>
          </div>
        </div>
      </div>


      <!-- #region VSS Form Component Start -->
      <div class="card mb-2" id="vss-form-card">
        <h5 class="card-header bg-primary text-white d-flex justify-content-between align-items-center">VSS
          <span id="vss-toggle-hidden-fields" role="button" tabindex="0" title="Show/hide hidden fields">
            <i class="bi bi-eye-slash"></i>
          </span>
        </h5>
        <div class="card-body">
          <div id="vss-form-component">
            <form id="vss-form">
              <div class="row mb-3">
                <div class="col-6">
                  <label for="runwaythr" class="form-label">Runway THR</label>
                  <select class="form-select" id="runwaythr">
                    <option value="">THR</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="runwayend" class="form-label">Runway End</label>
                  <select class="form-select" id="runwayend">
                    <option value="">END</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3" hidden>
                <div class="col-4">
                  <label for="thr-lat" class="form-label">THR Lat</label>
                  <input type="number" step="any" class="form-control" disabled id="thr-lat" value="">
                </div>
                <div class="col-4">
                  <label for="thr-lng" class="form-label">THR Lng</label>
                  <input type="number" step="any" class="form-control" disabled id="thr-lng" value="">
                </div>
                <div class="col-4">
                  <label for="rwyelev" class="form-label">Elev (m)</label>
                  <input type="number" step="any" class="form-control" disabled id="rwyelev" value="">
                </div>
              </div>

              <div class="row mb-3" hidden>
                <div class="col-4">
                  <label for="rwyend-lat" class="form-label">END Lat</label>
                  <input type="number" step="any" class="form-control" disabled id="rwyend-lat" value="">
                </div>
                <div class="col-4">
                  <label for="rwyend-lng" class="form-label">END Lng</label>
                  <input type="number" step="any" class="form-control" disabled id="rwyend-lng" value="">
                </div>
                <div class="col-4">
                  <label for="rwyelev" class="form-label">Elev (m)</label>
                  <input type="number" step="any" class="form-control" disabled id="rwyendelev" value="">
                </div>
                <div class="col-4">
                  <label for="fac" class="form-label">RWY Bearing (deg T)</label>
                  <input type="number" step="any" class="form-control" disabled id="fac" value=""
                    data-bs-toggle="tooltip"
                    title="Calculated runway bearing. This value may be different from what is on the chart">
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-6">
                  <label for="vpa" class="form-label">VPA (deg)</label>
                  <input type="number" step="any" class="form-control" id="vpa" value="3.0">
                </div>
                <div class="col-6">
                  <label for="och" class="form-label">OCH (ft)</label>
                  <input type="number" step="any" class="form-control" id="och" value="500" data-bs-toggle="tooltip"
                    title="Use the highest OCH">
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-4">
                  <label for="runwaycode" class="form-label">Code</label>
                  <select class="form-select" id="runwaycode">
                    <option value="">1, 2</option>
                    <option value="3,4" selected>3, 4</option>
                  </select>
                </div>
                <div class="col-4">
                  <label for="strip" class="form-label">Strip Width (m)</label>
                  <input type="number" step="any" class="form-control" id="strip" value="280">
                </div>
                <div class="col-4">
                  <label for="fac" class="form-label">Offset (deg)</label>
                  <input type="number" step="any" class="form-control" id="offsetangle" value="0"
                    data-bs-toggle="tooltip"
                    title="Offset angle in degrees (negative value is offset left, positive value is offset right)">
                </div>
              </div>

              <div class="row mb-3">

                <div class="col-4">
                  <button type="submit" class="btn btn-primary w-100">Draw VSS</button>
                </div>
                <div class="col-4">
                  <button type="button" class="btn btn-secondary w-100" id="export-kml">Export
                    KML</button>
                </div>
                <div class="col-4">
                  <button type="button" class="btn btn-danger w-100">Clear</button>
                </div>

              </div>

            </form>
          </div>

        </div>
      </div>


      <!-- #endregion VSS Form Component End -->

      <!-- #region DEP OIS Form Component Start -->
      <div class="card mb-2" id="dep-ois-form-card">
        <h5 class="card-header bg-secondary text-white">DEP OIS</h5>
        <div class="card-body">
          <div id="dep-ois-form-component">
            <form id="dep-ois-form">
              <div class="row mb-3">
                <div class="col-6">
                  <label for="dep-startrwy" class="form-label">RWY Start</label>
                  <select class="form-select" id="dep-startrwy">
                    <option value="">START</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="dep-rwythr" class="form-label">RWY End</label>
                  <select class="form-select" id="dep-rwythr">
                    <option value="">END</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3" hidden>
                <div class="col-4">
                  <label for="dep-start-lat" class="form-label">START Lat</label>
                  <input type="number" step="any" class="form-control" disabled id="dep-start-lat" value="">
                </div>
                <div class="col-4">
                  <label for="dep-start-lng" class="form-label">START Lng</label>
                  <input type="number" step="any" class="form-control" disabled id="dep-start-lng" value="">
                </div>
                <div class="col-4">
                  <label for="dep-start-elev" class="form-label">Elev (m)</label>
                  <input type="number" step="any" class="form-control" disabled id="dep-start-elev" value="">
                </div>
              </div>

              <div class="row mb-3" hidden>
                <div class="col-4">
                  <label for="dep-end-lat" class="form-label">END Lat</label>
                  <input type="number" step="any" class="form-control" disabled id="dep-end-lat" value="">
                </div>
                <div class="col-4">
                  <label for="dep-end-lng" class="form-label">END Lng</label>
                  <input type="number" step="any" class="form-control" disabled id="dep-end-lng" value="">
                </div>
                <div class="col-4">
                  <label for="dep-end-elev" class="form-label">Elev (m)</label>
                  <input type="number" step="any" class="form-control" disabled id="dep-end-elev" value="">
                </div>
              </div>


              <div class="row mb-3">
                <div class="col-4">
                  <label for="cwy-length" class="form-label">CWY Length</label>
                  <input type="number" step="any" class="form-control" id="cwy-length" value="0">
                </div>

                <!-- <div class="col-4">
                <label for="dep-type" class="form-label">Type</label>
                <select class="form-select" id="dep-type">
                  <option value="straight">Straight</option>
                  <option value="turning">Turning</option>
                </select>
              </div> -->
                <div class="col-4">
                  <label for="dep-offset" class="form-label">Offset (deg)</label>
                  <input type="number" step="any" class="form-control" id="dep-offset" value="0">
                </div>

              </div>
              <div class="row mb-3">
                <div class="col-4">
                  <button type="submit" class="btn btn-primary w-100">Draw OIS</button>
                </div>
                <div class="col-4">
                  <button type="button" class="btn btn-secondary w-100" id="dep-export-kml">Export
                    KML</button>
                </div>
                <div class="col-4">
                  <button type="button" class="btn btn-danger w-100" id="dep-clear">Clear</button>
                </div>


              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- #endregion DEP OIS Form Component End -->

      <!-- Common CSV Upload Component Start -->
      <div class="card mb-2">
        <div class="card-body">
          <div id="csv-upload-component" class="row mb-3">
            <div class="col-12 mt-2 mb-2 d-flex align-items-end">
              <div class="flex-grow-1">
                <label for="common-csv-upload" class="form-label">Upload CSV</label>
                <input type="file" class="form-control" id="common-csv-upload" accept=".csv">
              </div>
              <button type="button" class="btn btn-outline-secondary ms-2" id="common-csv-redefine"
                title="Redefine CSV columns">
                <i class="bi bi-pencil-square"></i>
              </button>
            </div>
            <div class="col-12 mt-2">
              <button type="button" class="btn btn-success w-100" id="evaluate-common-csv">Evaluate CSV</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Common CSV Upload Component End -->
    </div>




    <!-- Sticky copyright block inside sidebar -->
    <div class="w-100 mt-auto" style="position:sticky; bottom:0; background:inherit; z-index:9999;">
      <hr class="my-2" style="margin-bottom:0.2rem;" />
      <div class="text-smaller text-muted text-center">
        Copyright &copy; 2025 <a href="https://aeropath.aero" target="_blank">Aeropath</a>
      </div>
    </div>
  </div>


  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="static/ruler/leaflet-ruler.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="map.js"></script>
  <script src="main.js"></script>
  <script src="datamgr.js"></script>
  <script src="csv-modal.js"></script>
  <script src="vss3d-utils.js"></script>
  <script src="evaluation.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script>
    // Searchable Aerodrome Dropdown Logic
    (function () {
      const searchInput = document.getElementById('aerodrome-search');
      const listContainer = document.getElementById('aerodrome-list-container');
      const hiddenAerodromeInput = document.getElementById('aerodrome');
      let aerodromeOptions = []; // To store { value: 'ICAO', text: 'ICAO - Name' }

      function parseAerodromesFromCsv(csvText) {
        const lines = csvText.split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) return []; // Need header + at least one data row

        // Aerodrome codes are in the 17th column (index 16)
        const aerodromeCodeColumnIndex = 16;

        // Optional: Check if header exists and has enough columns, though we're using a fixed index.
        // const header = lines[0].split(',');
        // if (header.length <= aerodromeCodeColumnIndex) {
        //   console.error(`CSV header doesn't have column ${aerodromeCodeColumnIndex + 1} for aerodrome codes.`);
        //   return [];
        // }

        const aerodromes = {}; // Use object to ensure uniqueness by aerodrome code
        for (let i = 1; i < lines.length; i++) { // Start from 1 to skip header
          const row = lines[i].split(',');
          if (row.length > aerodromeCodeColumnIndex) {
            const code = row[aerodromeCodeColumnIndex]?.trim();
            if (code && !aerodromes[code]) {
              // Use the code itself as the value and text for the dropdown
              aerodromes[code] = code;
            }
          }
        }

        return Object.entries(aerodromes).map(([value, text]) => ({ value, text }))
          .sort((a, b) => a.text.localeCompare(b.text)); // Sort alphabetically
      }

      function renderAerodromeList(filterText = '') {
        listContainer.innerHTML = ''; // Clear previous items
        const lowerFilterText = filterText.toLowerCase();
        const filteredOptions = aerodromeOptions.filter(opt =>
          opt.text.toLowerCase().includes(lowerFilterText)
        );

        if (filteredOptions.length === 0 && filterText) {
          const noResultsItem = document.createElement('div');
          noResultsItem.className = 'list-group-item text-muted';
          noResultsItem.textContent = 'No aerodromes found';
          listContainer.appendChild(noResultsItem);
        } else {
          filteredOptions.forEach(opt => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = opt.text;
            item.dataset.value = opt.value;
            item.addEventListener('mousedown', function (e) { // mousedown to act before blur
              e.preventDefault(); // Prevent blur from hiding list before click registers
              searchInput.value = this.textContent;
              hiddenAerodromeInput.value = this.dataset.value;
              // Dispatch a change event on the hidden input for other scripts to listen to
              hiddenAerodromeInput.dispatchEvent(new Event('change', { bubbles: true }));
              listContainer.style.display = 'none';
            });
            listContainer.appendChild(item);
          });
        }
        listContainer.style.display = (filteredOptions.length > 0 || (filterText && filteredOptions.length === 0)) && searchInput === document.activeElement ? 'block' : 'none';
      }

      function fetchAndPrepareAerodromes() {
        const csvPath = '../data/runways.csv'; // Assuming runways.csv is in the parent directory
        fetch(csvPath)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Network response was not ok: ${response.statusText} for ${csvPath}`);
            }
            return response.text();
          })
          .then(csvText => {
            aerodromeOptions = parseAerodromesFromCsv(csvText);
            if (aerodromeOptions.length === 0 && !csvText.includes('icao')) { // Basic check if CSV was even parsable
              listContainer.innerHTML = '<div class="list-group-item text-danger">Error parsing aerodromes. Check CSV format.</div>';
            }
            // Optionally render list if search input already has text (e.g. after refresh)
            // renderAerodromeList(searchInput.value); 
          })
          .catch(error => {
            console.error('Failed to fetch or parse aerodromes:', error);
            listContainer.innerHTML = `<div class="list-group-item text-danger">Could not load aerodromes. ${error.message}</div>`;
            aerodromeOptions = [];
          });
      }

      searchInput.addEventListener('input', () => {
        renderAerodromeList(searchInput.value);
      });

      searchInput.addEventListener('focus', () => {
        // Show all or filtered if already has text
        renderAerodromeList(searchInput.value);
        // Ensure list is shown if there are options or if it's empty and needs to show a message
        if (aerodromeOptions.length > 0 || searchInput.value) {
          listContainer.style.display = 'block';
        }
      });

      searchInput.addEventListener('blur', () => {
        // Delay hiding to allow click on list items
        setTimeout(() => {
          if (!listContainer.contains(document.activeElement)) { // Hide only if focus didn't move to a list item
            listContainer.style.display = 'none';
          }
        }, 150);
      });

      document.getElementById('refresh-aerodrome')?.addEventListener('click', function () {
        searchInput.value = '';
        hiddenAerodromeInput.value = '';
        hiddenAerodromeInput.dispatchEvent(new Event('change', { bubbles: true }));
        fetchAndPrepareAerodromes(); // Re-fetch and parse
        listContainer.style.display = 'none';
      });

      // Initial load
      fetchAndPrepareAerodromes();
    })();
  </script>
</body>

</html>